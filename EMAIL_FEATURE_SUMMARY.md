# 문의 폼 개선 사항 - 이메일 & 다운로드 기능 추가

## 📋 변경 사항 요약

### 1. **HTML 이메일 템플릿 추가**
- ✅ 로고 + 테이블 + CTA 버튼이 포함된 프로페셔널한 HTML 이메일
- ✅ 접수 날짜/시간을 KST(Asia/Seoul)로 표시
- ✅ 모바일 최적화 + 다크모드 대응
- ✅ 상담하기 버튼(카카오톡) + 전체 기록 다운로드 링크 포함

### 2. **접수 날짜 추가**
- ✅ 이메일 상단에 "접수일시" 표시 (예: 2026-01-27 11:34 KST)
- ✅ ISO 타임스탬프도 작은 글씨로 함께 표기
- ✅ 모든 레코드에 createdAt 저장

### 3. **전체 기록 다운로드 기능**
- ✅ 토큰 기반 보안 인증 (HMAC-SHA256)
- ✅ 24시간 유효 기간 설정
- ✅ CSV 형식으로 모든 문의 기록 제공
- ✅ 이메일 하단에 다운로드 링크 포함

### 4. **로컬 기록 저장**
- ✅ JSON 파일 기반 저장 (`.data/leads.json`)
- ✅ 각 레코드에 id, createdAt, 신청자 정보 포함
- ✅ 프로덕션에서는 SQLite/PostgreSQL로 업그레이드 가능

## 📁 추가된 파일

```
lib/
  ├── emailTemplate.ts        # HTML 이메일 템플릿 생성
  ├── downloadToken.ts        # 토큰 생성/검증 (HMAC-SHA256)
  ├── leadRecords.ts         # 레코드 저장/조회 (JSON 기반)
  └── sendEmail.ts           # Resend API를 통한 이메일 발송

app/api/
  ├── lead/
  │   └── route.ts           # 수정됨 - 레코드 저장 + 이메일 발송 통합
  └── admin/records/download/
      └── route.ts           # 새로 추가 - 토큰 검증 후 CSV 다운로드

.env.example                  # 필수 환경 변수 샘플
EMAIL_SETUP.md               # 설정 및 사용 가이드
```

## ⚙️ 필수 환경 변수 설정

`.env.local` 파일에 다음을 추가하세요:

```bash
# 관리자 이메일
ADMIN_EMAIL=your-email@example.com
NEXT_PUBLIC_ADMIN_EMAIL=your-email@example.com

# Resend API (https://resend.com)
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com

# 사이트 URL (다운로드 링크용)
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# 다운로드 토큰 시크릿 (프로덕션에서 변경)
DOWNLOAD_TOKEN_SECRET=your-secret-key-change-in-prod
```

## 🔄 동작 흐름

### 폼 제출 시:
1. 사용자가 문의 폼 제출
2. `/api/lead` POST 요청
3. Google Sheets에 저장 (기존 로직)
4. **→ 로컬 JSON에 레코드 저장 (새로 추가)**
5. **→ 관리자 이메일 발송 (새로 추가)**
   - 이메일 본문: 신청자 정보 + 접수 날짜 + CTA 버튼
   - 다운로드 링크 포함 (토큰 자동 생성)

### 다운로드 요청 시:
1. 이메일 하단의 "전체 기록 다운로드" 링크 클릭
2. `/api/admin/records/download?token={token}` 요청
3. 토큰 검증 (유효한지, 만료 여부)
4. CSV 파일 다운로드

## 📧 이메일 템플릿 구성

```
┌─────────────────────────────┐
│  메타페이 (헤더)             │ ← 오렌지 그래디언트
├─────────────────────────────┤
│ [창업문의] 새 문의가 도착    │
├─────────────────────────────┤
│ 접수일시: 2026-01-27 ...   │
├─────────────────────────────┤
│ 이름    | 김철수              │
│ 연락처  | 010-1234-5678    │
│ 지역    | 서울시 강남구       │
│ 문의    | 카페 렌탈...       │
├─────────────────────────────┤
│        [상담하기]            │ ← CTA 버튼
├─────────────────────────────┤
│  📥 전체 기록 다운로드       │ ← 관리자용
├─────────────────────────────┤
│ 본 메일은 자동 발송...       │ ← 푸터
└─────────────────────────────┘
```

## 🔒 보안

- **토큰 기반 인증**: HMAC-SHA256으로 서명
- **시간 제한**: 24시간 유효기간 (확장 가능)
- **만료 검증**: 토큰 유효하지 않으면 401 응답
- **환경 변수**: 시크릿 키는 env에서만 관리

## 📊 저장된 데이터 포맷

### JSON 레코드 (`.data/leads.json`)
```json
[
  {
    "id": "1704067234567-abc123",
    "name": "김철수",
    "phone": "010-1234-5678",
    "region": "서울시 강남구",
    "message": "카페 창업에 관심 있습니다.",
    "createdAt": "2026-01-27T02:34:56.789Z",
    "userAgent": "Mozilla/5.0..."
  }
]
```

### CSV 다운로드 (lead-records-2026-01-27.csv)
```csv
ID,이름,연락처,지역,문의내용,접수일시
1704067234567-abc123,김철수,010-1234-5678,서울시 강남구,카페 창업에 관심 있습니다.,2026-01-27T02:34:56.789Z
```

## ⚠️ 주의사항

1. **Resend API 키 필수**: 없으면 이메일이 발송되지 않습니다.
2. **Google Sheets 로직 유지**: 기존 로직은 그대로 유지됨
3. **프로덕션 업그레이드**: JSON 파일 대신 데이터베이스 권장
4. **토큰 시크릿 변경**: 프로덕션에서는 강력한 랜덤 문자열로 변경

## 🚀 배포 준비

1. Resend에서 API 키 발급
2. `.env.local` 설정 (또는 환경 변수 설정)
3. `npm run dev` 로 테스트
4. 폼 제출 후 이메일 수신 확인
5. 다운로드 링크 클릭 후 CSV 다운로드 확인

## 📞 지원

설정 중 문제가 있으면:
1. [EMAIL_SETUP.md](./EMAIL_SETUP.md) 참고
2. 서버 로그 확인 (`[API/POST]`, `[Email]` 검색)
3. 환경 변수 재확인
